<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Football League Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Fantasy Football League Dashboard</h1>
        
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Search League Statistics</h2>
            <select id="searchType" class="mb-4 p-2 border rounded">
                <option value="ppg">Points Per Game</option>
                <option value="highScore">Highest Score Ever</option>
                <option value="lowScore">Lowest Score Ever</option>
                <option value="matchups">Matchups Between Users</option>
                <option value="winPercentage">Win Percentage</option>
                <option value="longestWinStreak">Longest Win Streak</option>
                <option value="highestScoringWeek">Highest Scoring Week</option>
            </select>
            <div id="matchupInputs" class="hidden mb-4">
                <select id="user1" class="p-2 border rounded mr-2"></select>
                <select id="user2" class="p-2 border rounded"></select>
            </div>
            <button id="searchButton" class="bg-blue-500 text-white px-4 py-2 rounded">Search</button>
            <div id="searchResults" class="mt-4"></div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Debug Information</h2>
            <div id="debugInfo"></div>
        </div>
    </div>

    <script>
        const LEAGUE_ID = '954612791405527040';
        const API_BASE_URL = 'https://api.sleeper.app/v1';
        let leagueUsers = [];
        let players = {};

        async function fetchData(endpoint) {
            const response = await fetch(`${API_BASE_URL}${endpoint}`);
            return response.json();
        }

        async function fetchLeagueUsers() {
            leagueUsers = await fetchData(`/league/${LEAGUE_ID}/users`);
            updateUserDropdowns();
        }

        function updateUserDropdowns() {
            const userDropdowns = ['user1', 'user2'];
            userDropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                dropdown.innerHTML = leagueUsers.map(user => 
                    `<option value="${user.user_id}">${user.display_name}</option>`
                ).join('');
            });
        }

        async function fetchPlayers() {
            players = await fetchData('/players/nfl');
        }

        function updateDebugInfo(message) {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.innerHTML += `<p>${message}</p>`;
        }

        function getUsernameById(userId) {
            const user = leagueUsers.find(u => u.user_id === userId);
            return user ? user.display_name : 'Unknown';
        }

        async function getMatchupsBetweenUsers(user1Id, user2Id) {
            updateDebugInfo('Fetching matchup data...');
            let user1Wins = 0;
            let user2Wins = 0;
            let matchups = [];

            const leagueInfo = await fetchData(`/league/${LEAGUE_ID}`);
            let currentLeagueId = LEAGUE_ID;
            let currentSeason = leagueInfo.season;

            while (currentLeagueId) {
                updateDebugInfo(`Processing season ${currentSeason}...`);
                const rosters = await fetchData(`/league/${currentLeagueId}/rosters`);
                const user1RosterId = rosters.find(r => r.owner_id === user1Id)?.roster_id;
                const user2RosterId = rosters.find(r => r.owner_id === user2Id)?.roster_id;

                if (user1RosterId && user2RosterId) {
                    for (let week = 1; week <= 17; week++) {
                        const weekMatchups = await fetchData(`/league/${currentLeagueId}/matchups/${week}`);
                        const user1Matchup = weekMatchups.find(m => m.roster_id === user1RosterId);
                        const user2Matchup = weekMatchups.find(m => m.roster_id === user2RosterId);

                        if (user1Matchup && user2Matchup && user1Matchup.matchup_id === user2Matchup.matchup_id) {
                            if (user1Matchup.points > user2Matchup.points) user1Wins++;
                            else if (user2Matchup.points > user1Matchup.points) user2Wins++;

                            matchups.push({
                                season: currentSeason,
                                week: week,
                                user1Score: user1Matchup.points,
                                user2Score: user2Matchup.points,
                                user1Players: user1Matchup.players,
                                user2Players: user2Matchup.players,
                                user1Starters: user1Matchup.starters,
                                user2Starters: user2Matchup.starters,
                                user1PlayerPoints: user1Matchup.players_points || {},
                                user2PlayerPoints: user2Matchup.players_points || {}
                            });
                        }
                    }
                }

                const prevLeagueInfo = await fetchData(`/league/${currentLeagueId}`);
                currentLeagueId = prevLeagueInfo.previous_league_id;
                currentSeason = prevLeagueInfo.season;
            }

            updateDebugInfo('Matchup data fetched successfully.');
            return { matchups, user1Wins, user2Wins };
        }

        function getPlayerDetails(playerId) {
            const player = players[playerId];
            if (player) {
                return `${player.full_name} (${player.position})`;
            } else if (playerId && playerId.startsWith('DEF')) {
                return `${playerId.replace('_', ' ')} DEF`;
            } else {
                return 'Unknown Player';
            }
        }

        function displayPlayerScores(playerIds, starterIds, playerPoints) {
            const starters = starterIds.map(id => {
                const score = playerPoints[id] || 0;
                return `<li>${getPlayerDetails(id)}: ${score.toFixed(2)} points</li>`;
            }).join('');

            const bench = playerIds.filter(id => !starterIds.includes(id)).map(id => {
                const score = playerPoints[id] || 0;
                return `<li>${getPlayerDetails(id)}: ${score.toFixed(2)} points</li>`;
            }).join('');

            return `
                <h4 class="font-semibold mt-2">Starters:</h4>
                <ul>${starters}</ul>
                <h4 class="font-semibold mt-2">Bench:</h4>
                <ul>${bench}</ul>
            `;
        }
        async function findHighestScore() {
            updateDebugInfo('Finding highest score...');
            let highestScore = { score: 0, username: '', season: '', week: 0 };
            const leagueInfo = await fetchData(`/league/${LEAGUE_ID}`);
            let currentLeagueId = LEAGUE_ID;
            let currentSeason = leagueInfo.season;

            while (currentLeagueId) {
                updateDebugInfo(`Processing season ${currentSeason}...`);
                const rosters = await fetchData(`/league/${currentLeagueId}/rosters`);
                
                for (let week = 1; week <= 17; week++) {
                    const weekMatchups = await fetchData(`/league/${currentLeagueId}/matchups/${week}`);
                    weekMatchups.forEach(matchup => {
                        if (matchup.points > highestScore.score) {
                            const userId = rosters.find(r => r.roster_id === matchup.roster_id)?.owner_id;
                            highestScore = {
                                score: matchup.points,
                                username: getUsernameById(userId),
                                season: currentSeason,
                                week: week
                            };
                        }
                    });
                }

                const prevLeagueInfo = await fetchData(`/league/${currentLeagueId}`);
                currentLeagueId = prevLeagueInfo.previous_league_id;
                currentSeason = prevLeagueInfo.season;
            }

            updateDebugInfo('Highest score found successfully.');
            return highestScore;
        }
        async function findLowestScore() {
            updateDebugInfo('Finding lowest score...');
            let lowestScore = { score: Infinity, username: '', season: '', week: 0 };
            const leagueInfo = await fetchData(`/league/${LEAGUE_ID}`);
            let currentLeagueId = LEAGUE_ID;
            let currentSeason = leagueInfo.season;

            while (currentLeagueId) {
                updateDebugInfo(`Processing season ${currentSeason}...`);
                const rosters = await fetchData(`/league/${currentLeagueId}/rosters`);
                
                for (let week = 1; week <= 17; week++) {
                    const weekMatchups = await fetchData(`/league/${currentLeagueId}/matchups/${week}`);
                    weekMatchups.forEach(matchup => {
                        if (matchup.points < lowestScore.score) {
                            const userId = rosters.find(r => r.roster_id === matchup.roster_id)?.owner_id;
                            lowestScore = {
                                score: matchup.points,
                                username: getUsernameById(userId),
                                season: currentSeason,
                                week: week
                            };
                        }
                    });
                }

                const prevLeagueInfo = await fetchData(`/league/${currentLeagueId}`);
                currentLeagueId = prevLeagueInfo.previous_league_id;
                currentSeason = prevLeagueInfo.season;
            }

            updateDebugInfo('Lowest score found successfully.');
            return lowestScore;
        }
async function calculatePointsPerGame() {
            updateDebugInfo('Calculating points per game...');
            const ppg = {};
            const leagueInfo = await fetchData(`/league/${LEAGUE_ID}`);
            let currentLeagueId = LEAGUE_ID;
            let currentSeason = leagueInfo.season;

            while (currentLeagueId) {
                updateDebugInfo(`Processing season ${currentSeason}...`);
                const rosters = await fetchData(`/league/${currentLeagueId}/rosters`);
                
                for (let week = 1; week <= 17; week++) {
                    const weekMatchups = await fetchData(`/league/${currentLeagueId}/matchups/${week}`);
                    weekMatchups.forEach(matchup => {
                        const userId = rosters.find(r => r.roster_id === matchup.roster_id)?.owner_id;
                        if (userId) {
                            if (!ppg[userId]) ppg[userId] = { totalPoints: 0, games: 0 };
                            ppg[userId].totalPoints += matchup.points;
                            ppg[userId].games++;
                        }
                    });
                }

                const prevLeagueInfo = await fetchData(`/league/${currentLeagueId}`);
                currentLeagueId = prevLeagueInfo.previous_league_id;
                currentSeason = prevLeagueInfo.season;
            }

            const result = Object.entries(ppg).map(([userId, data]) => ({
                username: getUsernameById(userId),
                ppg: data.games > 0 ? (data.totalPoints / data.games).toFixed(2) : 0
            }));

            updateDebugInfo('Points per game calculated successfully.');
            return result.sort((a, b) => b.ppg - a.ppg);
        }
       async function performSearch() {
            const searchType = document.getElementById('searchType').value;
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = 'Searching...';
            let results = '';

            switch (searchType) {
                case 'ppg':
                    const ppgResults = await calculatePointsPerGame();
                    results = ppgResults.map(user => 
                        `<li>${user.username}: ${user.ppg} points per game</li>`
                    ).join('');
                    resultsDiv.innerHTML = `<ul>${results}</ul>`;
                    break;

                case 'highScore':
                    const highest = await findHighestScore();
                    resultsDiv.innerHTML = `Highest score: ${highest.username} scored ${highest.score.toFixed(2)} points in week ${highest.week} of the ${highest.season} season`;
                    break;

                case 'lowScore':
                    const lowest = await findLowestScore();
                    resultsDiv.innerHTML = `Lowest score: ${lowest.username} scored ${lowest.score.toFixed(2)} points in week ${lowest.week} of the ${lowest.season} season`;
                    break;
                case 'matchups':
                 const user1Id = document.getElementById('user1').value;
                        const user2Id = document.getElementById('user2').value;
                        const { matchups, user1Wins, user2Wins } = await getMatchupsBetweenUsers(user1Id, user2Id);
                        const user1Name = getUsernameById(user1Id);
                        const user2Name = getUsernameById(user2Id);
                        results = matchups.map(m => 
                            `<li>
                                <details>
                                    <summary>${m.season} Season, Week ${m.week}: ${user1Name} ${m.user1Score.toFixed(2)} - ${m.user2Score.toFixed(2)} ${user2Name}</summary>
                                    <div class="pl-4">
                                        <h3 class="font-semibold mt-2">${user1Name}'s Team:</h3>
                                        ${displayPlayerScores(m.user1Players, m.user1Starters, m.user1PlayerPoints)}
                                        <h3 class="font-semibold mt-4">${user2Name}'s Team:</h3>
                                        ${displayPlayerScores(m.user2Players, m.user2Starters, m.user2PlayerPoints)}
                                    </div>
                                </details>
                            </li>`
                        ).join('');
                        resultsDiv.innerHTML = matchups.length ? 
                            `<p><strong>Head-to-head record:</strong> ${user1Name} ${user1Wins} - ${user2Wins} ${user2Name}</p>
                            <ul>${results}</ul>` : 
                            'No matchups found between these users.';
                        break;

                // Implement other search types here
                default:
                    resultsDiv.innerHTML = 'Search type not implemented yet.';
            }
        }
        document.getElementById('searchType').addEventListener('change', function() {
            document.getElementById('matchupInputs').style.display = 
                this.value === 'matchups' ? 'block' : 'none';
        });

        document.getElementById('searchButton').addEventListener('click', performSearch);

        async function initializeDashboard() {
            await fetchLeagueUsers();
            await fetchPlayers();
            updateDebugInfo('Dashboard initialized. Ready for searches.');
        }

        initializeDashboard();
    </script>
</body>
</html>
