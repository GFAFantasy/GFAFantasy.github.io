<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Football League Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Fantasy Football League Dashboard</h1>
        
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Search League Statistics</h2>
            <select id="searchType" class="mb-4 p-2 border rounded">
                <option value="ppg">Points Per Game</option>
                <option value="highScore">Highest Score Ever</option>
                <option value="lowScore">Lowest Score Ever</option>
                <option value="matchups">Matchups Between Users</option>
                <option value="transactions">Transactions Between Users</option>
                <option value="winPercentage">Win Percentage</option>
                <option value="longestWinStreak">Longest Win Streak</option>
                <option value="highestScoringWeek">Highest Scoring Week</option>
            </select>
            <div id="userInputs" class="hidden mb-4">
                <select id="user1" class="p-2 border rounded mr-2"></select>
                <select id="user2" class="p-2 border rounded"></select>
            </div>
            <div id="yearInput" class="mb-4">
                <select id="yearSelect" class="p-2 border rounded">
                    <option value="all">All Years</option>
                </select>
            </div>
            <button id="searchButton" class="bg-blue-500 text-white px-4 py-2 rounded">Search</button>
            <div id="searchResults" class="mt-4"></div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Debug Information</h2>
            <div id="debugInfo"></div>
        </div>
    </div>

    <script>
        const LEAGUE_ID = '954612791405527040';
        const API_BASE_URL = 'https://api.sleeper.app/v1';
        let leagueUsers = [];
        let players = {};
        let leagueHistory = [];

        async function fetchData(endpoint) {
            const response = await fetch(`${API_BASE_URL}${endpoint}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        }

        function updateDebugInfo(message) {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.innerHTML += `<p>${message}</p>`;
        }

        async function fetchLeagueUsers() {
            leagueUsers = await fetchData(`/league/${LEAGUE_ID}/users`);
            updateUserDropdowns();
        }

        function updateUserDropdowns() {
            const userDropdowns = ['user1', 'user2'];
            userDropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                dropdown.innerHTML = leagueUsers.map(user => 
                    `<option value="${user.user_id}">${user.display_name}</option>`
                ).join('');
            });
        }

        async function fetchPlayers() {
            players = await fetchData('/players/nfl');
        }

        async function fetchLeagueHistory() {
            let currentLeagueId = LEAGUE_ID;
            let currentSeason;
            
            while (currentLeagueId) {
                const leagueInfo = await fetchData(`/league/${currentLeagueId}`);
                currentSeason = leagueInfo.season;
                leagueHistory.unshift({ id: currentLeagueId, season: currentSeason });
                currentLeagueId = leagueInfo.previous_league_id;
            }
            
            updateYearDropdown();
        }

        function updateYearDropdown() {
            const yearSelect = document.getElementById('yearSelect');
            yearSelect.innerHTML = '<option value="all">All Years</option>' + 
                leagueHistory.map(league => 
                    `<option value="${league.season}">${league.season}</option>`
                ).join('');
        }

        function getUsernameById(userId) {
            const user = leagueUsers.find(u => u.user_id === userId);
            return user ? user.display_name : 'Unknown';
        }

        function getPlayerDetails(playerId) {
            const player = players[playerId];
            if (player) {
                return `${player.full_name} (${player.position})`;
            } else if (playerId && playerId.startsWith('DEF')) {
                return `${playerId.replace('_', ' ')} DEF`;
            } else {
                return 'Unknown Player';
            }
        }

        async function getMatchupsBetweenUsers(user1Id, user2Id, selectedYear) {
            updateDebugInfo('Fetching matchup data...');
            let user1Wins = 0;
            let user2Wins = 0;
            let matchups = [];

            try {
                for (const league of leagueHistory) {
                    if (selectedYear === 'all' || league.season === selectedYear) {
                        updateDebugInfo(`Processing season ${league.season}...`);
                        const rosters = await fetchData(`/league/${league.id}/rosters`);
                        const user1RosterId = rosters.find(r => r.owner_id === user1Id)?.roster_id;
                        const user2RosterId = rosters.find(r => r.owner_id === user2Id)?.roster_id;

                        if (user1RosterId && user2RosterId) {
                            for (let week = 1; week <= 17; week++) {
                                const weekMatchups = await fetchData(`/league/${league.id}/matchups/${week}`);
                                const user1Matchup = weekMatchups.find(m => m.roster_id === user1RosterId);
                                const user2Matchup = weekMatchups.find(m => m.roster_id === user2RosterId);

                                if (user1Matchup && user2Matchup && user1Matchup.matchup_id === user2Matchup.matchup_id) {
                                    if (user1Matchup.points > user2Matchup.points) user1Wins++;
                                    else if (user2Matchup.points > user1Matchup.points) user2Wins++;

                                    matchups.push({
                                        season: league.season,
                                        week: week,
                                        user1Score: user1Matchup.points,
                                        user2Score: user2Matchup.points,
                                        user1Players: user1Matchup.players,
                                        user2Players: user2Matchup.players,
                                        user1Starters: user1Matchup.starters,
                                        user2Starters: user2Matchup.starters,
                                        user1PlayerPoints: user1Matchup.players_points || {},
                                        user2PlayerPoints: user2Matchup.players_points || {}
                                    });
                                }
                            }
                        }
                    }
                }

                updateDebugInfo('Matchup data fetched successfully.');
                return { matchups, user1Wins, user2Wins };
            } catch (error) {
                updateDebugInfo(`Error fetching matchup data: ${error.message}`);
                throw error;
            }
        }

        async function getTransactionsBetweenUsers(user1Id, user2Id, selectedYear) {
            updateDebugInfo('Fetching transaction data...');
            let transactions = [];

            try {
                for (const league of leagueHistory) {
                    if (selectedYear === 'all' || league.season === selectedYear) {
                        updateDebugInfo(`Processing transactions for season ${league.season}...`);
                        const rosters = await fetchData(`/league/${league.id}/rosters`);
                        const user1RosterId = rosters.find(r => r.owner_id === user1Id)?.roster_id;
                        const user2RosterId = rosters.find(r => r.owner_id === user2Id)?.roster_id;

                        if (user1RosterId && user2RosterId) {
                            for (let week = 1; week <= 17; week++) {
                                const weekTransactions = await fetchData(`/league/${league.id}/transactions/${week}`);
                                const relevantTransactions = weekTransactions.filter(t => 
                                    t.roster_ids.includes(user1RosterId) && t.roster_ids.includes(user2RosterId)
                                );

                                transactions.push(...relevantTransactions.map(t => ({
                                    ...t,
                                    season: league.season,
                                    week: week
                                })));
                            }
                        }
                    }
                }

                updateDebugInfo('Transaction data fetched successfully.');
                return transactions;
            } catch (error) {
                updateDebugInfo(`Error fetching transaction data: ${error.message}`);
                throw error;
            }
        }

        function formatTransaction(transaction, user1Name, user2Name) {
            let details = '';
            if (transaction.type === 'trade') {
                const adds1 = Object.keys(transaction.adds || {}).filter(playerId => transaction.adds[playerId] === transaction.roster_ids[0]);
                const adds2 = Object.keys(transaction.adds || {}).filter(playerId => transaction.adds[playerId] === transaction.roster_ids[1]);
                const drops1 = Object.keys(transaction.drops || {}).filter(playerId => transaction.drops[playerId] === transaction.roster_ids[0]);
                const drops2 = Object.keys(transaction.drops || {}).filter(playerId => transaction.drops[playerId] === transaction.roster_ids[1]);

                details += `${user1Name} received: ${adds1.map(id => getPlayerDetails(id)).join(', ')}<br>`;
                details += `${user2Name} received: ${adds2.map(id => getPlayerDetails(id)).join(', ')}<br>`;
                
                if (transaction.draft_picks && transaction.draft_picks.length > 0) {
                    details += 'Draft picks traded:<br>';
                    transaction.draft_picks.forEach(pick => {
                        const receiver = pick.owner_id === transaction.roster_ids[0] ? user1Name : user2Name;
                        details += `${receiver} received: Round ${pick.round} pick (${pick.season} season)<br>`;
                    });
                }
            }
            return `
                <li>
                    <strong>${transaction.season} Season, Week ${transaction.week}</strong><br>
                    Type: ${transaction.type}<br>
                    ${details}
                </li>
            `;
        }

        function displayPlayerScores(playerIds, starterIds, playerPoints) {
            const starters = starterIds.map(id => {
                const score = playerPoints[id] || 0;
                return `<li>${getPlayerDetails(id)}: ${score.toFixed(2)} points</li>`;
            }).join('');

            const bench = playerIds.filter(id => !starterIds.includes(id)).map(id => {
                const score = playerPoints[id] || 0;
                return `<li>${getPlayerDetails(id)}: ${score.toFixed(2)} points</li>`;
            }).join('');

            return `
                <h4 class="font-semibold mt-2">Starters:</h4>
                <ul>${starters}</ul>
                <h4 class="font-semibold mt-2">Bench:</h4>
                <ul>${bench}</ul>
            `;
        }

        async function performSearch() {
            const searchType = document.getElementById('searchType').value;
            const resultsDiv = document.getElementById('searchResults');
            const selectedYear = document.getElementById('yearSelect').value;
            resultsDiv.innerHTML = 'Searching...';
            let results = '';

            try {
                switch (searchType) {
                    case 'matchups':
                        const user1Id = document.getElementById('user1').value;
                        const user2Id = document.getElementById('user2').value;
                        const { matchups, user1Wins, user2Wins } = await getMatchupsBetweenUsers(user1Id, user2Id, selectedYear);
                        const user1Name = getUsernameById(user1Id);
                        const user2Name = getUsernameById(user2Id);
                        results = matchups.map(m => 
                            `<li>
                                <details>
                                    <summary>${m.season} Season, Week ${m.week}: ${user1Name} ${m.user1Score.toFixed(2)} - ${m.user2Score.toFixed(2)} ${user2Name}</summary>
                                    <div class="pl-4">
                                        <h3 class="font-semibold mt-2">${user1Name}'s Team:</h3>
                                        ${displayPlayerScores(m.user1Players, m.user1Starters, m.user1PlayerPoints)}
                                        <h3 class="font-semibold mt-4">${user2Name}'s Team:</h3>
                                        ${displayPlayerScores(m.user2Players, m.user2Starters, m.user2PlayerPoints)}
                                    </div>
                                </details>
                            </li>`
                        ).join('');
                        resultsDiv.innerHTML = matchups.length ? 
                            `<p><strong>Head-to-head record:</strong> ${user1Name} ${user1Wins} - ${user2Wins} ${user2Name}</p>
                            <ul>${results}</ul>` : 
                            'No matchups found between these users.';
                        break;

                    case 'transactions':
                        const transUser1Id = document.getElementById('user1').value;
                        const transUser2Id = document.getElementById('user2').value;
                        const transactions = await getTransactionsBetweenUsers(transUser1Id, transUser2Id, selectedYear);
                        const transUser1Name = getUsernameById(transUser1Id);
                        const transUser2Name = getUsernameById(transUser2Id);
                        results = transactions.map(t => formatTransaction(t, transUser1Name, transUser2Name)).join('');
                        resultsDiv.innerHTML = transactions.length ?
                            `<h3>Transactions between ${transUser1Name} and ${transUser2Name}:</h3><ul>${results}</ul>` :
                            'No transactions found between these users.';
                        break;

                    // Implement other search types here
                    default:
                        resultsDiv.innerHTML = 'Search type not implemented yet.';
                }
            } catch (error) {
                resultsDiv.innerHTML = `An error occurred: ${error.message}`;
            }
        }

       document.getElementById('searchType').addEventListener('change', function() {
            document.getElementById('userInputs').style.display = 
                ['matchups', 'transactions'].includes(this.value) ? 'block' : 'none';
        });

        document.getElementById('searchButton').addEventListener('click', performSearch);

        async function initializeDashboard() {
            try {
                updateDebugInfo('Initializing dashboard...');
                await fetchLeagueUsers();
                await fetchPlayers();
                await fetchLeagueHistory();
                updateDebugInfo('Dashboard initialized. Ready for searches.');
            } catch (error) {
                updateDebugInfo(`Error initializing dashboard: ${error.message}`);
            }
        }

        initializeDashboard();
    </script>
</body>
</html>
